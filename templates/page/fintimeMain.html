<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <title>Fin-Time</title>
    <link rel="icon" href="{{ url_for('static', filename='assets/images/favicon-32x32.png') }}" type="image/png">
    <!-- FullCalendar core -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <!-- FullCalendar DayGrid Plugin (ê·¸ë¦¬ë“œ ë·°) -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>

    <!-- FullCalendar List Plugin (ë¦¬ìŠ¤íŠ¸ ë·°) -->
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.15/index.global.min.js"></script>

    <!-- FullCalendar ìŠ¤íƒ€ì¼ (í•„ìš”ì‹œ ì¶”ê°€) -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.css" rel="stylesheet"> -->


    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-ui.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>

    <style>
        #titlebar {
            position: relative;
            display: flex;
            justify-content: center; /* h1ì„ ì¤‘ì•™ ì •ë ¬ */
            align-items: center;
            padding: 15px 20px; /* ë†’ì´ë¥¼ ëŠ˜ë¦¬ë ¤ë©´ padding ê°’ì„ ì¡°ì • */
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            height: 30px; /* ë†’ì´ ì¡°ì ˆ */
        }

        #titlebar h1 {
            margin: 0;
            font-size: 20px;
            position: absolute; /* ê°€ìš´ë° ê³ ì • */
            left: 50%;
            transform: translateX(-50%); /* ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ */
        }

        #titlebar button {
            position: absolute;
            right: 20px; /* ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ */
            padding: 8px 12px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        #titlebar button:hover {
            background-color: #0056b3;
        }

        /* ê¸°ë³¸ ì„¤ì • */
        #calendar {
            max-width: 100%;
            margin: 0 auto;
        }

        /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ ë‹¬ë ¥ í¬ê¸° ì¡°ì • */
        @media (max-width: 768px) {
            #calendar {
                width: 100%;
                padding: 0 10px;
            }
        }

        @media (max-width: 480px) {
            #calendar {
                width: 100%;
                padding: 0;
            }
        }
       
        .fc-daygrid-day-top {
            display: flex;
            justify-content: space-between; /* ë‚ ì§œ ì™¼ìª½, ê³µíœ´ì¼ ì˜¤ë¥¸ìª½ */
            align-items: center;
            padding: 0 4px; /* ì¢Œìš° íŒ¨ë”© ì¡°ì • */
        }

        .fc-daygrid-day-top.has-holiday .fc-daygrid-day-number,
        .fc-list-day.has-holiday .fc-list-day-text {
            color: red !important; /* ë‚ ì§œë¥¼ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }

        .holiday-label {
            font-size: 12px;
            color: red;
            white-space: nowrap; /* ê³µíœ´ì¼ ì´ë¦„ ì¤„ë°”ê¿ˆ ë°©ì§€ */
            text-align: left; /* ì™¼ìª½ ì •ë ¬ */
            margin-right: auto; /* ì™¼ìª½ìœ¼ë¡œ ë°€ê¸° */
            margin-left: 4px; /* ë‚ ì§œ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜ */
        }

        .fc-daygrid-day-number {
            flex-shrink: 0;
            text-align: right; /* ë‚ ì§œ ì˜¤ë¥¸ìª½ ì •ë ¬ */
        }

        .fc-day-sat {
            background-color: white;
            color: #007bff;
        }

        .fc-day-sun {
            background-color: white;
            color: #ff5733;
        }

        .fc-daygrid-more-link,
        .fc-more-link {
            color: black !important;  /* 'ë”ë³´ê¸°' í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê²€ì€ìƒ‰ */
        }
        
        /* ğŸ”¹ FullCalendar í—¤ë” ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜• í¬í•¨) */
        .fc-header-toolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            flex-wrap: nowrap; /* í•œ ì¤„ë¡œ ë°°ì¹˜ (ì¤„ ë°”ê¿ˆ ì•ˆë¨) */
        }

        /* ğŸ”¹ FullCalendar íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
        .fc-toolbar-title {
            font-size: 16px !important; /* íƒ€ì´í‹€ í°íŠ¸ í¬ê¸° ì¤„ì´ê¸° */
            font-weight: bold;
            color: #333; /* í°íŠ¸ ìƒ‰ìƒ */
            text-align: center; /* íƒ€ì´í‹€ì„ ê°€ìš´ë° ì •ë ¬ */
            margin: 0;
            padding: 5px;
        }

        /* ğŸ”¹ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .fc .fc-button {
            background-color: #007bff;
            color: white !important;
            border: none;
            padding: 6px 10px; /* ë²„íŠ¼ í¬ê¸° ì¤„ì´ê¸° */
            font-size: 12px; /* ê¸€ì í¬ê¸° ì¶•ì†Œ */
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 5px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* ğŸ”¹ today ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .fc .fc-today-button {
            background-color: #28a745 !important;
            color: white !important;
        }

        /* ğŸ”¹ prev, next ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì‚¬ì´ì¦ˆ í†µì¼ & ì›í˜• ë²„íŠ¼) */
        .fc .fc-prev-button,
        .fc .fc-next-button {
            background-color: #6c757d !important;
            color: white !important;
            border-radius: 50%;
            width: 30px !important;
            height: 30px !important;
            min-width: 30px !important;
            min-height: 30px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px !important;
            padding: 0 !important;
        }

        /* ğŸ”¹ View ì „í™˜ ë²„íŠ¼ (dayGridMonth, listMonth) */
        .fc .fc-dayGridMonth-button,
        .fc .fc-listMonth-button {
            background-color: #17a2b8 !important;
            color: white !important;
            font-size: 12px; /* ê¸€ì í¬ê¸° ì¶•ì†Œ */
            font-weight: bold;
            padding: 6px 10px; /* ë²„íŠ¼ í¬ê¸° ì¤„ì´ê¸° */
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        /* ğŸ”¹ View ë²„íŠ¼ í™œì„±í™” ì‹œ ê°•ì¡° */
        .fc .fc-button-active {
            background-color: #117a8b !important;
            font-weight: bold;
            border: 2px solid white;
        }

        /* ğŸ”¹ ë²„íŠ¼ ê°„ê²© ì¡°ì • */
        .fc .fc-toolbar-chunk {
            display: flex;
            align-items: center;
        }

        /* ğŸ”¹ ë²„íŠ¼ ê°„ê²© ì¡°ì • */
        .fc .fc-toolbar-chunk:first-child {
            margin-right: auto;
        }

        /* ğŸ”¹ ëª¨ë°”ì¼ í™”ë©´ì—ì„œ ë²„íŠ¼ í¬ê¸° ë° ì •ë ¬ ì¡°ì • */
        @media (max-width: 768px) {
            .fc-header-toolbar {
                padding: 8px 15px; /* ëª¨ë°”ì¼ì—ì„œ í—¤ë” ì—¬ë°± ì¡°ì • */
            }

            .fc-toolbar-title {
                font-size: 14px !important; /* ëª¨ë°”ì¼ì—ì„œ íƒ€ì´í‹€ í°íŠ¸ í¬ê¸° ë” ì‘ê²Œ */
            }

            /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .fc .fc-button {
                padding: 5px 8px; /* ë²„íŠ¼ í¬ê¸° ë” ì¤„ì´ê¸° */
                font-size: 10px; /* ê¸€ì í¬ê¸° ë” ì¤„ì´ê¸° */
                margin: 0 4px;
            }

            .fc .fc-prev-button,
            .fc .fc-next-button {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }

            .fc .fc-today-button {
                font-size: 10px !important;
                padding: 5px 8px !important;
            }

            /* ë²„íŠ¼ë“¤ì„ í•œ ì¤„ë¡œ ë°°ì¹˜ */
            .fc .fc-toolbar-chunk {
                width: auto;
                display: flex;
                justify-content: center;
            }
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
       #eventSidebar {
            position: fixed; /* í™”ë©´ ê¸°ì¤€ ê³ ì • */
            top: 0;
            right: -1000px; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
            padding: 20px;
            transition: right 0.3s ease-in-out;
            z-index: 1000; /* ìº˜ë¦°ë”ë³´ë‹¤ ë†’ì€ ê°’ìœ¼ë¡œ ì„¤ì • */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
        }
        
        .fc { 
            z-index: 500 !important; /* ìº˜ë¦°ë”ì˜ z-indexë¥¼ ë‚®ì¶¤ */
        }


    </style>
</head>
<body>
    <div id="titlebar">
        <h1>Fin-Time</h1>
        <button id="mypageBtn"onclick="goTopage(this)">ì„¤ì •</button>
    </div>

    <div id="calendar"></div>
    <!-- ì‚¬ì´ë“œë°” ì¶”ê°€ -->
    <div id="eventSidebar">
        <h4>Event Details</h4>
        <p><strong>Title:</strong> <span id="sidebarEventTitle"></span></p>
        <p><strong>Start:</strong> <span id="sidebarEventStart"></span></p>
        <p><strong>End:</strong> <span id="sidebarEventEnd"></span></p>
        <p><strong>Detail Link:</strong> <span id="sidebarEventDescription"></span></p>
        <button onclick="closeSidebar()">Close</button>
    </div>

    <script>
        let holidayModified = false; // ì œëª©ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        let holidays = []; // ê³µíœ´ì¼ ë°ì´í„°
        var calendarEl
        var calendar

        $(document).ready(function () {
            requestHoliday();
        })

        function requestHoliday() {
            $.ajax({
                url: "{{api_domain}}/getHoiDay",
                type: "POST",
                success: function (response) {
                    holidays = response.map(function(holiday) {
                        const rawDate = holiday.hoi_date;
                        const formattedDate = `${rawDate.slice(0, 4)}-${rawDate.slice(4, 6)}-${rawDate.slice(6, 8)}`;

                        return {
                            //date: formattedDate,  // ê³µíœ´ì¼ ë‚ ì§œ
                            date: holiday.hoi_date,
                            name: holiday.hoi_name   // ê³µíœ´ì¼ ì´ë¦„
                        };
                    });
                    
                    initCalendar();
                },
                error: function () {
                    alert("ê³µíœ´ì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        function initCalendar() {
            calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'ko',
                aspectRatio: 0.7,
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'title prev,next today',
                    right: 'dayGridMonth,listMonth'
                },
                titleFormat: { 
                    year: 'numeric', 
                    month: '2-digit'
                },
                eventSources: [
                    {
                        url: "{{api_domain}}/getEventMst",  // API ì—”ë“œí¬ì¸íŠ¸
                        method: "POST",
                        success: function (response) {
                            // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°(response)ë¥¼ FullCalendar í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                            return response.map(event => {
                                const startDate = new Date(event.evt_st_dt);  // ì‹œì‘ ë‚ ì§œ
                                startDate.setHours(0, 0, 0, 0); // ì‹œë¶„ì´ˆ ì´ˆê¸°í™”

                                const endDate = new Date(event.evt_ed_dt);    // ì¢…ë£Œ ë‚ ì§œ
                                endDate.setHours(0, 0, 0, 0); // ì‹œë¶„ì´ˆ ì´ˆê¸°í™”

                                return {
                                    title: "[" + event.cor_nm + "] " + event.evt_title,
                                    start: startDate, // ISO í˜•ì‹ (YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss)
                                    end: endDate || startDate, // ì¢…ë£Œ ë‚ ì§œ ì—†ìœ¼ë©´ ì‹œì‘ ë‚ ì§œë¡œ ì„¤ì •
                                    description: event.evt_dt_link || "No description",
                                    backgroundColor: event.cor_color,
                                    borderColor: event.cor_color,
                                    textColor: "white"
                                };
                            });
                        },
                        failure: function () {
                            alert("ì´ë²¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                ],
                datesSet: function(info) {
                    markHolidays();
                },
                eventClick: function(info) {
                    // í´ë¦­í•œ ì´ë²¤íŠ¸ ì •ë³´
                    const event = info.event;

                    // ì‚¬ì´ë“œë°” ë‚´ìš© ì—…ë°ì´íŠ¸
                    document.getElementById('sidebarEventTitle').textContent = event.title;
                    document.getElementById('sidebarEventStart').textContent = event.start.toLocaleString();
                    document.getElementById('sidebarEventEnd').textContent = event.end ? event.end.toLocaleString() : 'N/A';
                    document.getElementById('sidebarEventDescription').innerHTML = event.extendedProps.description 
                        ? `<a href="${event.extendedProps.description}" target="_blank">${event.extendedProps.description}</a>` 
                        : 'No Link';

                    // ì‚¬ì´ë“œë°” ì—´ê¸°
                    document.getElementById('eventSidebar').style.right = "0px";
                },
                eventDidMount: function(info) {
                    // íŒì˜¤ë²„ ì™¸ë¶€ í´ë¦­ ì‹œ íŒì˜¤ë²„ ë‹«ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
                    const popover = info.el.querySelector('.fc-popover');
                    if (popover) {
                        document.addEventListener('click', function(event) {
                            if (!popover.contains(event.target)) {
                                popover.style.display = 'none'; // íŒì˜¤ë²„ ë‹«ê¸°
                            }
                        });
                    }

                    // ì‹œê°„ ìš”ì†Œë¥¼ ìˆ¨ê¸°ê¸°
                    const eventTimeElement = info.el.querySelector('.fc-event-time');
                    
                    if (eventTimeElement) {
                        eventTimeElement.style.display = 'none'; // ì‹œê°„ ìˆ¨ê¸°ê¸°
                    }

                    const listEventTimeElement = info.el.querySelector('.fc-list-event-time');
                    
                    if (listEventTimeElement) {
                        listEventTimeElement.style.display = 'none'; // ì‹œê°„ ìˆ¨ê¸°ê¸°
                    }
                },
                dayMaxEvents: 5, 
                moreLinkText: function(n) { // ë”ë³´ê¸° í…ìŠ¤íŠ¸ ì„¤ì •
                    return 'ë”ë³´ê¸° (' + n + ')';
                }
            });
            calendar.render();
        }

        // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (YYYYMMDD â†’ YYYYë…„ Mì›” Dì¼)
        function formatDate(holidayDate) {
            return holidayDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1ë…„ $2ì›” $3ì¼')
                            .replace(/0(\d)ì›”/, '$1ì›”')
                            .replace(/0(\d)ì¼/, '$1ì¼');
        }

        // ê³µíœ´ì¼ í‘œì‹œ í•¨ìˆ˜
        function markHolidays() {
            document.querySelectorAll('.holiday-label').forEach(el => el.remove());

            document.querySelectorAll('.fc-daygrid-day-top, .fc-list-day').forEach(el => {
                const ariaLabel = el.querySelector('.fc-daygrid-day-number, .fc-list-day-text')?.getAttribute('aria-label'); // ë‚ ì§œ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°

                holidays.forEach(holiday => {
                    if (ariaLabel === formatDate(holiday.date)) {
                        const holidayLabel = document.createElement('span');
                        holidayLabel.classList.add('holiday-label');
                        holidayLabel.innerText = holiday.name;

                        el.classList.add('has-holiday'); // ê³µíœ´ì¼ì´ ìˆëŠ” ë‚ ì— í´ë˜ìŠ¤ ì¶”ê°€

                        // ë‹¬ë ¥ ë·° ì²˜ë¦¬
                        if (el.classList.contains('fc-daygrid-day-top')) {
                            el.insertBefore(holidayLabel, el.firstChild); // ë‚ ì§œ ì™¼ìª½ì— ì¶”ê°€
                        }

                        // ë¦¬ìŠ¤íŠ¸ ë·° ì²˜ë¦¬
                        if (el.classList.contains('fc-list-day')) {
                            const listDayText = el.querySelector('.fc-list-day-text');
                            if (listDayText) {
                                listDayText.appendChild(holidayLabel); // ë¦¬ìŠ¤íŠ¸ ë‚ ì§œ ì˜†ì— ê³µíœ´ì¼ ì¶”ê°€
                            }
                        }
                    }
                });
            });
        }

        // ì‚¬ì´ë“œë°” ë‹«ê¸° í•¨ìˆ˜
        function closeSidebar() {
            document.getElementById('eventSidebar').style.right = "-1000px";
        }
    </script>

</body>
</html>
